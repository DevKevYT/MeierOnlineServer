<!Eine Testapp zum testen halt>
<html>
	<head>
		<title>MeyerOnlineDevClient</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script type="text/javascript">
			
			var clientID;
			var sessionID;
			var displayName;
			var currentMatchID;
			let eventSource;
			var matchDone = false;
			
			function POST(theUrl, payload) {
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.open( "POST", theUrl, false );
				xmlHttp.setRequestHeader("Content-Type", "multipart/form-data;charset=UTF-8");
				xmlHttp.send(payload);
				return xmlHttp.responseText;
			}
			
			function login() {
				var result = POST("http://localhost:8080/api/createguest/", "displayName=" + document.getElementById("name").value);
				var json = JSON.parse(result);
				console.log(json);
				clientID = json.data.uuid;
				
				showScreen("match_overview");
			}
			
			function createMatch() {
				var result = JSON.parse(POST("http://localhost:8080/api/match/create/", "clientID=" + clientID));
				console.log(result);
				if(result.code != 0) {
					alert("Error while creating a match: " + result.errorMessage);
					return;
				}
				sessionID = result.data.sessionID;
				currentMatchID = result.data.matchID;

				runMatch();
				
				showScreen("gamescreen");
				
				document.getElementById("match-id").innerHTML = "Match ID: " + currentMatchID;
			}
			
			function joinMatch() {
				var result = JSON.parse(POST("http://localhost:8080/api/match/join/" + document.getElementById("joinmatch").value, "clientID=" + clientID));
				console.log(result);
				if(result.code == 0) { 
				
					sessionID = result.data.sessionID;
					
					console.log("Connecting to server eventSource");
					runMatch();
					
					showScreen("gamescreen");
					setOnlinePlayerList(result.data.joinedClients);
				} else {
					alert(result.errorMessage);
				}
			}
			
			function runMatch() {
				eventSource = new EventSource("http://localhost:8080/heartbeat/" + sessionID);

				eventSource.onerror = (e) => {
					console.log("Ein Fehler bei der Verbindung ist aufgetreten!");
					sessionID = undefined;
					
					eventSource.close();
					eventSource = undefined;
					
					showScreen("match_overview");
				};
				
				eventSource.addEventListener('match-join', function(e) {
					var data = JSON.parse(e.data);
					appendGameLog(data.displayName + " ist der Runde beigetreten!");
					
					setOnlinePlayerList(data.currentMembers);
					console.log(e.data);
				});
				
				eventSource.addEventListener('match-leave', function(e) {
					var data = JSON.parse(e.data);
					appendGameLog(data.displayName + " hat die Runde verlassen!");
					
					setOnlinePlayerList(data.currentMembers);
					console.log(e.data);
				});
				
				eventSource.addEventListener('host-promotion', function(e) {
					appendGameLog("Du bist jetzt der Host");
					console.log(e.data);
				});
				
				eventSource.addEventListener('new-turn-die-value', function(e) {
					var data = JSON.parse(e.data);
					appendGameLog("Du hast " + data.dieValues + " gewürfelt!");
					console.log(e.data);
				});
				
				eventSource.addEventListener('new-turn', function(e) {
					var data = JSON.parse(e.data);
					var displayName = data.prevDisplayName;
					var cid = data.clientID;
					
					if(cid == clientID) {
						if(data.streak > 0) {
							appendGameLog("Du bist dran! " + displayName + " meint, eine " + JSON.parse(e.data).toldDieRoll + " gewürfelt zu haben!");
						}
					} else {
						appendGameLog(data.displayName  + " ist an der Reihe");
					}
					
					console.log(e.data);
				});
				
				eventSource.addEventListener('finish-match', function(e) {
					var data = JSON.parse(e.data);
					
					if(data.loser.uuid != clientID) {
						appendGameLog("    Die Runde ist vorbei! " + data.loser.displayName + " hat verloren!<br>    " + data.toldDieRoll + " wurde angesagt, der echte Wert war: " + data.actualDieRoll);
						appendGameLog(data.loser.displayName + " kann mit 'Würfeln' eine neue Runde beginnen");
					} else {
						appendGameLog("    Die Runde ist vorbei! Du hast verloren!<br>    " + data.toldDieRoll + " wurde angesagt, der echte Wert war: " + data.actualDieRoll);
						appendGameLog("Du kannst mit 'Würfeln' eine neue Runde beginnen");
					}
					
					matchDone = true;
					console.log(e);
				});
				
				eventSource.addEventListener('match-cancelled', function(e) {
					var data = JSON.parse(e.data);
					appendGameLog("Die aktuelle Runde wurde abgebrochen: " + data.reason + " " + data.newTurn.displayName + " ist an der Reihe und startet die neue Runde");
					
				});
			}
			
			function challenge() {
				var result = JSON.parse(POST("http://localhost:8080/api/match/next/?challenge=true", "sessionID=" + sessionID));
				console.log(result);
				
				if(result.code != 0) {
					alert("Error: " + result.errorMessage);
					return;
				}
			}
			
			function roll() {
				if(matchDone) {
					document.getElementById("event-display").innerHTML = "";
					matchDone = false;
				}
				var result = JSON.parse(POST("http://localhost:8080/api/match/roll/", "sessionID=" + sessionID));
				console.log(result);
				
				if(result.code != 0) {
					alert("Error: " + result.errorMessage);
					return;
				}
			}
			
			function passon() {
				var result = JSON.parse(POST("http://localhost:8080/api/match/next/?dieValue=" + document.getElementById("guess").value, "sessionID=" + sessionID));
				console.log(result);
				
				if(result.code != 0) {
					alert("Error while: " + result.errorMessage);
					return;
				}
			}
			
			function leave() {
				var result = JSON.parse(POST("http://localhost:8080/api/match/leave/", "sessionID=" + sessionID));
				console.log(result);
				
				if(result.code != 0) {
					alert("Error while: " + result.errorMessage);
					return;
				}
				showScreen("match_overview");
				eventSource.close();
			}
			
			function appendGameLog(text) {
				document.getElementById("event-display").innerHTML += ">> " + text + "<br>";
			}
			
			function showScreen(screen) {
				
				document.getElementById("gamescreen").style.display = "none";
				document.getElementById("guest_login").style.display = "none";
				document.getElementById("match_overview").style.display = "none";
				document.getElementById(screen).style.display = "block";
			}
			
			function setOnlinePlayerList(jsonData) {
				document.getElementById("online-player-list").innerHTML = "";
				
				console.log(jsonData);
				for(let element in jsonData) {
					document.getElementById("online-player-list").innerHTML += "<li>" + jsonData[element].displayName + "</li>";
				}
			}
			
		</script>
		
		<style>
		
			a {
				font-family: "Arial";
			}
			
			.gamelogs {
				min-height:200px;
				background:#efefef;
				padding:10px;
				margin:10px;
				display:inline-flex;
				flex: 1;
			}
			
			.game-controls {
				display: block;
			}
			
			.online-players {
				display: inline-flex;
				background:#efefef;
				padding: 10px;
				min-height: 200px;
				background:#efefef;
				flex: 0.2;
				margin: 10px;
				padding: 10px;
				position: relative;
			}
			
			.logs-wrapper {
				display: flex;
				width: 100%;
			}
			
			#online-player-list {
				list-style: none;
				margin: 0px;
				padding: 0px;
				margin-top: 40px;
			}
		</style>
	</head>
		
	<body>
		<div id="guest_login">
			<a>Bitte wähle einen Nicknamen:</a><br>
			<input type="text" id="name"></input><br>
			<input type="submit" onclick="login()"></input>
		</div>
		<div id="match_overview" style="display:none;">
			<a>Erstelle, oder trete einem Match bei!</a><br>
			<button onclick="createMatch()">Erstelle Match</button><br><br>
			<a>4 stellige Match id:</a>
			<input type="text" id="joinmatch"></input><br>
			<button onclick="joinMatch()">Beitreten</button>
		</div>
		
		<div id="gamescreen" style="display: none;">
			<a id="match-id"></a>
			<button id="leave" onclick="leave()" style="position:absolute;right:20px;">Verlassen</button><br>
			
			<div class="logs-wrapper">
				<div class="gamelogs">
					<a id="event-display"></a>
				</div>
				<div class="online-players">
					<a style="position: absolute;top:10px;left: 10px;">Online Spieler:</a>
					<ul id="online-player-list">
						
					</ul>
				</div>
			</div>
			
			<div class="game-controls">
				<button id="challenge" onclick="challenge()">Anzweifeln</button>
				<button id="roll" onclick="roll()">Würfeln</button><br>
				<a>Sag den anderen, was du gewürfelt hast: </a><input type="text" id="guess"><br>
				<button id="passon" onclick="passon()">Weitergeben</button><br><br>
			</div>
		</div>
	</body>
</html>